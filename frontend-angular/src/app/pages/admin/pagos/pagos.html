<div class="pagos-page">
    <div class="page-head">
        <div>
            <h2>Registro de Pagos</h2>
            <p>Registrar y consultar pagos de contratos</p>
        </div>
        <button class="btn-green" type="button" (click)="cargarListaContratos()">üîÑ Actualizar Lista</button>
    </div>

    <div class="grid-top">
        <section class="card">
            <div class="card-title">Registrar Nuevo Pago</div>

            <div class="form">
                <div class="info-line" *ngIf="!resumen">
                    ‚ÑπÔ∏è Seleccione un contrato para ver su deuda.
                </div>
                <div class="info-line" *ngIf="resumen && resumen.saldo === 0"
                    style="background-color: #dcfce7; color: #166534;">
                    üéâ ¬°Contrato pagado en su totalidad!
                </div>
                <div class="info-line" *ngIf="resumen && resumen.saldo > 0"
                    style="background-color: #fee2e2; color: #991b1b;">
                    ‚ö†Ô∏è Deuda Pendiente: <strong>S/ {{ resumen.saldo | number:'1.2-2' }}</strong>
                </div>

                <div class="form-group">
                    <label class="label">Contrato / Cliente: *</label>
                    <select class="input" [(ngModel)]="nuevoPago.contrato_id" (change)="alSeleccionarContrato()">
                        <option [value]="0">Seleccione un contrato existente...</option>

                        <option *ngFor="let c of listaContratos" [value]="c.id">
                            #{{ c.id }} - {{ getNombreCliente(c) }} {{ c.paquete ? '(' + c.paquete + ')' : '' }}
                        </option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="label">Monto del Pago: *</label>
                        <input type="number" class="input" [(ngModel)]="nuevoPago.monto" placeholder="S/ 0.00"
                            [disabled]="!resumen || resumen.saldo === 0" />
                    </div>

                    <div class="form-group">
                        <label class="label">Fecha de Pago: *</label>
                        <input type="date" class="input" [(ngModel)]="nuevoPago.fecha_pago" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="label">M√©todo de Pago: *</label>
                    <select class="input" [(ngModel)]="nuevoPago.metodo">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Yape">Yape</option>
                        <option value="Plin">Plin</option>
                        <option value="Tarjeta">Tarjeta</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="label">Comprobante (Imagen):</label>
                    <input type="file" id="fileInput" class="input" (change)="onFileSelected($event)"
                        accept="image/*" />
                </div>

                <div class="form-group">
                    <label class="label">Observaciones:</label>
                    <input class="input" [(ngModel)]="nuevoPago.observacion" placeholder="Nro Operaci√≥n, detalles..." />
                </div>

                <div class="actions">
                    <button class="btn-save" type="button" (click)="registrarPago()"
                        [disabled]="!resumen || resumen.saldo === 0"
                        [style.opacity]="(!resumen || resumen.saldo === 0) ? 0.5 : 1">
                        Registrar Pago
                    </button>
                </div>
            </div>
        </section>

        <section class="card resumen">
            <div class="card-title">Resumen del Contrato</div>

            <div class="res-body">
                <div class="res-sub" *ngIf="!resumen">Seleccione un contrato...</div>

                <div class="money-icon">{{ resumen?.saldo === 0 ? '‚úÖ' : 'üí∞' }}</div>

                <div class="res-grid" *ngIf="resumen">
                    <div class="row">
                        <div class="k">Estado:</div>
                        <div class="v">
                            <span class="pill"
                                [ngClass]="{'ok': resumen.estado==='completo', 'bad': resumen.estado!=='completo'}">
                                {{ resumen.estado | uppercase }}
                            </span>
                        </div>
                    </div>
                    <hr />
                    <div class="row">
                        <div class="k">Total Contrato:</div>
                        <div class="v">{{ resumen.monto_total | currency:'PEN':'S/ ' }}</div>
                    </div>
                    <div class="row">
                        <div class="k ok">Total Pagado:</div>
                        <div class="v ok">{{ resumen.total_pagado | currency:'PEN':'S/ ' }}</div>
                    </div>
                    <div class="row">
                        <div class="k bad">Saldo Pendiente:</div>
                        <div class="v bad">{{ resumen.saldo | currency:'PEN':'S/ ' }}</div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <section class="card table-card">
        <div class="table-head">
            <div class="table-title">Historial de Pagos</div>
        </div>

        <!-- PAGINACI√ìN -->
        <div class="pagination-bar" *ngIf="listaPagos.length > pageSize"
            style="display: flex; justify-content: flex-end; align-items: center; gap: 20px; margin-bottom: 15px; padding: 10px;">
            <button [disabled]="paginaActual === 1" (click)="cambiarPagina(paginaActual - 1)"
                style="padding: 8px 15px; border-radius: 5px; cursor: pointer; background: #22c55e; color: white; border: none;">Anterior</button>
            <span style="font-weight: bold; color: #22c55e;">P√°gina {{ paginaActual }} de {{ totalPaginas }}</span>
            <button [disabled]="paginaActual === totalPaginas" (click)="cambiarPagina(paginaActual + 1)"
                style="padding: 8px 15px; border-radius: 5px; cursor: pointer; background: #22c55e; color: white; border: none;">Siguiente</button>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>M√©todo</th>
                    <th>Comprobante</th>
                    <th>Observaci√≥n</th>
                    <th>Monto</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let pago of pagosPaginados">
                    <td>{{ pago.fecha_pago | date:'dd/MM/yyyy' }}</td>
                    <td>
                        <span
                            style="font-weight: 500; font-size: 0.9em; padding: 2px 6px; background: #f1f5f9; border-radius: 4px;">
                            {{ pago.metodo }}
                        </span>
                    </td>

                    <td style="text-align: center;">
                        <a *ngIf="pago.comprobante_url" [href]="apiUrl + '/' + pago.comprobante_url" target="_blank"
                            style="text-decoration: none; font-size: 1.2rem;" title="Ver Comprobante">
                            üñºÔ∏è
                        </a>
                        <span *ngIf="!pago.comprobante_url" style="color: #ccc;">-</span>
                    </td>

                    <td>{{ pago.observacion || '-' }}</td>
                    <td class="money">{{ pago.monto | currency:'PEN':'S/ ' }}</td>
                    <td class="actions-td">
                        <button class="icon-btn gray" style="color:red" (click)="eliminarPago(pago.id)"
                            title="Eliminar">üóëÔ∏è</button>
                    </td>
                </tr>
                <tr *ngIf="listaPagos.length === 0">
                    <td colspan="6" style="text-align: center; color: #94a3b8; padding:30px;">
                        No hay pagos registrados para este contrato.
                    </td>
                </tr>
            </tbody>
        </table>
    </section>
</div>