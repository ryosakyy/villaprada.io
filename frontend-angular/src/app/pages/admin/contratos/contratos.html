<div class="contratos-page">
    <div class="page-head">
        <div>
            <h2>Gesti√≥n de Contratos</h2>
            <p>Registra tus eventos y genera los documentos legales.</p>
        </div>
        <button class="btn-gold" type="button" disabled>Modo Administrador</button>
    </div>

    <div class="grid-top">

        <section class="card">
            <div class="card-title">Registrar Nuevo Contrato</div>

            <div class="form">

                <div class="form-group">
                    <label class="label">Buscar y Seleccionar Cliente: *</label>
                    <div class="input-group" style="margin-bottom: 5px;">
                        <input type="text" class="input" placeholder="üîç Escribe DNI o Nombre para filtrar..."
                            [(ngModel)]="textoBusquedaCliente" (input)="buscarCliente()"
                            style="font-size: 1rem; font-weight: bold; border-left: 4px solid #b5985a;">
                        <button class="btn-primary" (click)="abrirModalCliente()"
                            title="Agregar Cliente Nuevo">+</button>
                    </div>

                    <!-- SELECT DESPLEGABLE FILTRADO -->
                    <select class="input" [(ngModel)]="nuevoContrato.clienteId">
                        <option value="">-- Selecciona de la lista ({{ listaClientesFiltrados.length }} encontrados) --
                        </option>
                        <option *ngFor="let c of listaClientesFiltrados" [value]="c.id">
                            {{ c.dni }} - {{ c.nombres || c.nombre || c.name || 'Sin Nombre' }} {{ c.apellidos ||
                            c.apellido || '' }}
                        </option>
                    </select>

                    <!-- CUADRO DE CONFIRMACI√ìN (SOLO CUANDO YA SELECCION√ì) -->
                    <div class="id-status-box success" *ngIf="nuevoContrato.clienteId" style="margin-top: 10px;">
                        <div class="match-info">
                            <span class="check">‚úÖ</span>
                            <div class="data">
                                <strong>{{ obtenerNombreCliente(nuevoContrato.clienteId) }}</strong>
                                <small>DNI: {{ obtenerDniCliente(nuevoContrato.clienteId) }}</small>
                            </div>
                            <button class="btn-clear" (click)="limpiarClienteSeleccionado()">‚úï</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="label">Nombre del Paquete / Evento: *</label>
                    <input class="input" [(ngModel)]="nuevoContrato.paqueteStr"
                        placeholder="Ej. Boda de Juan y Maria..." />

                    <div class="helper-box">
                        <label class="helper-label">üì¶ Cargar Paquete Base:</label>
                        <div class="input-group">
                            <select class="input" style="font-size: 0.9rem;" (change)="usarPaquete($event)">
                                <option value="">-- Selecciona un Paquete --</option>
                                <option *ngFor="let p of listaPaquetes" [value]="p.id">
                                    {{ p.nombre }} - S/. {{ p.precio }}
                                </option>
                            </select>
                            <button class="btn-primary" (click)="abrirModalPaquete()"
                                title="Crear Nuevo Paquete">+</button>
                        </div>
                    </div>

                    <div class="helper-box" style="margin-top: 10px; background: #f0fdf4; border: 1px dashed #4ade80;">
                        <label class="helper-label" style="color: #15803d;">‚ûï Agregar Servicio Adicional:</label>

                        <div class="input-group">
                            <select class="input" style="font-size: 0.9rem;" (change)="agregarServicio($event)">
                                <option value="">-- Selecciona un Servicio --</option>
                                <option *ngFor="let s of listaServicios" [value]="s.id">
                                    {{ s.nombre }} (+ S/. {{ s.precio }})
                                </option>
                            </select>
                            <button class="btn-primary" (click)="abrirModalServicio()"
                                title="Crear Nuevo Servicio">+</button>
                        </div>

                        <small style="color: #15803d; font-size: 0.8rem;">* Al seleccionar, se suma al precio y se a√±ade
                            al nombre.</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="label">Fecha del Evento: *</label>
                        <input class="input" type="date" [(ngModel)]="nuevoContrato.fecha" [min]="hoy" />
                    </div>
                    <div class="form-group">
                        <label class="label">Hora Inicio:</label>
                        <input class="input" type="time" [(ngModel)]="nuevoContrato.horaIni" />
                    </div>
                    <div class="form-group">
                        <label class="label">Hora Fin:</label>
                        <input class="input" type="time" [(ngModel)]="nuevoContrato.horaFin" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="label">Monto Total (S/.): *</label>
                        <input class="input" type="number" placeholder="0.00" [(ngModel)]="nuevoContrato.montoTotal" />
                    </div>
                    <div class="form-group">
                        <label class="label">Adelanto (S/.):</label>
                        <input class="input" type="number" placeholder="0.00" [(ngModel)]="nuevoContrato.adelanto" />
                    </div>
                </div>

                <div class="actions">
                    <button class="btn-cancel" type="button" (click)="limpiarForm()">Limpiar</button>
                    <button class="btn-save" type="button" (click)="guardarContrato()">
                        üíæ Guardar Contrato
                    </button>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-title">Vista Previa / Info</div>
            <div class="pdf-body">
                <div class="pdf-icon">üìÑ</div>
                <div class="pdf-text">
                    Aqu√≠ podr√°s descargar el contrato una vez guardado.<br> Aseg√∫rate de que el cliente firme el
                    documento.
                </div>
                <button class="btn-download" disabled>Descargar Modelo</button>
            </div>
        </section>
    </div>

    <section class="card">
        <div class="card-title">Listado de Contratos Activos</div>

        <!-- B√öSQUEDA -->
        <div style="margin-bottom: 15px; padding: 0 10px;">
            <input type="text" placeholder="Buscar por cliente, paquete o ID..." [(ngModel)]="textoBusqueda"
                (input)="buscarContrato()"
                style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.95rem;">
        </div>

        <!-- PAGINACI√ìN -->
        <div class="pagination-bar" *ngIf="contratos.length > pageSize"
            style="display: flex; justify-content: flex-end; align-items: center; gap: 20px; margin-bottom: 15px; padding: 10px;">
            <button [disabled]="paginaActual === 1" (click)="cambiarPagina(paginaActual - 1)"
                style="padding: 8px 15px; border-radius: 5px; cursor: pointer; background: #34495e; color: white; border: none;">Anterior</button>
            <span style="font-weight: bold; color: #34495e;">P√°gina {{ paginaActual }} de {{ totalPaginas }}</span>
            <button [disabled]="paginaActual === totalPaginas" (click)="cambiarPagina(paginaActual + 1)"
                style="padding: 8px 15px; border-radius: 5px; cursor: pointer; background: #34495e; color: white; border: none;">Siguiente</button>
        </div>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Detalle Evento</th>
                        <th>Fecha</th>
                        <th>Total</th>
                        <th>Saldo (Por Pagar)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngIf="cargando">
                        <td colspan="7" class="empty">Cargando datos...</td>
                    </tr>
                    <tr *ngFor="let c of contratosPaginados">
                        <td><b>#{{ c.id }}</b></td>
                        <td>{{ c.cliente?.nombres || c.cliente?.nombre || obtenerNombreCliente(c.cliente_id) }}</td>
                        <td>{{ c.paquete }}</td>
                        <td>{{ c.fecha_evento }}</td>
                        <td>S/. {{ c.monto_total }}</td>
                        <td>
                            <span [style.color]="(c.monto_total - (c.adelanto || 0)) > 0 ? '#ef4444' : '#10b981'"
                                style="font-weight: bold;">
                                <ng-container *ngIf="(c.monto_total - (c.adelanto || 0)) > 0">
                                    Falta: S/. {{ (c.monto_total - (c.adelanto || 0)).toFixed(2) }}
                                </ng-container>
                                <ng-container *ngIf="(c.monto_total - (c.adelanto || 0)) <= 0">
                                    ‚úî ¬°Cancelado!
                                </ng-container>
                            </span>
                        </td>
                        <td>
                            <button class="btn-gold" (click)="descargarPDF(c.id)" title="Descargar PDF">üìÑ</button>
                            <button class="btn-cancel" style="margin-left:5px; padding: 5px 10px;"
                                (click)="eliminar(c.id)" title="Eliminar">üóëÔ∏è</button>
                        </td>
                    </tr>
                    <tr *ngIf="contratos.length === 0 && !cargando">
                        <td colspan="7" class="empty">No hay contratos registrados a√∫n.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
</div>

<div class="modal-overlay" *ngIf="mostrarModalCliente" (click.self)="cerrarModalCliente()">
    <div class="modal-content">
        <button class="btn-close-x" (click)="cerrarModalCliente()">√ó</button>
        <h3>Registrar Nuevo Cliente</h3>
        <div class="form-body">
            <div class="form-row">
                <div class="form-group">
                    <label class="label">DNI (8 d√≠gitos) *</label>
                    <input class="input" #dniNew maxlength="8" type="text" placeholder="Solo n√∫meros"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                <div class="form-group">
                    <label class="label">Nombres Completos *</label>
                    <input class="input" #nombreNew placeholder="Ej: Juan Perez">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="label">Tel√©fono</label>
                    <input class="input" #telNew placeholder="999888777">
                </div>
                <div class="form-group">
                    <label class="label">Correo Electr√≥nico</label>
                    <input class="input" #emailNew type="email" placeholder="cliente@correo.com">
                </div>
            </div>

            <div class="form-group">
                <label class="label">Direcci√≥n</label>
                <input class="input" #dirNew placeholder="Ej: Av. Principal 123">
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" (click)="cerrarModalCliente()">Cancelar</button>
                <button class="btn-primary"
                    (click)="guardarClienteRapido(dniNew.value, nombreNew.value, telNew.value, emailNew.value, dirNew.value)">Guardar
                    Cliente</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalPaquete" (click.self)="cerrarModalPaquete()">
    <div class="modal-content">
        <button class="btn-close-x" (click)="cerrarModalPaquete()">√ó</button>
        <h3>Crear Nuevo Paquete Base</h3>
        <div class="form-body">
            <div class="form-group"><label class="label">Nombre Paquete *</label><input class="input" #nomPaqNew
                    placeholder="Ej. Boda Premium"></div>
            <div class="form-group"><label class="label">Precio Base (S/.) *</label><input class="input" type="number"
                    #precioPaqNew placeholder="0.00"></div>
            <div class="form-row">
                <div class="form-group"><label class="label">Capacidad</label><input class="input" type="number"
                        #capPaqNew value="100"></div>
            </div>
            <div class="form-group"><label class="label">Servicios Incluidos</label><input class="input" #servPaqNew
                    placeholder="Ej. Local, Sillas, Sonido"></div>

            <div class="modal-actions">
                <button class="btn-secondary" (click)="cerrarModalPaquete()">Cancelar</button>
                <button class="btn-primary"
                    (click)="guardarPaqueteRapido(nomPaqNew.value, precioPaqNew.value, capPaqNew.value, servPaqNew.value)">Guardar
                    Paquete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" *ngIf="mostrarModalServicio" (click.self)="cerrarModalServicio()">
    <div class="modal-content">
        <button class="btn-close-x" (click)="cerrarModalServicio()">√ó</button>
        <h3>Crear Nuevo Servicio</h3>
        <div class="form-body">
            <div class="form-group">
                <label class="label">Nombre del Servicio *</label>
                <input class="input" [(ngModel)]="nuevoServicio.nombre" placeholder="Ej. Hora Loca, Mozos extra...">
            </div>

            <div class="form-group">
                <label class="label">Precio (S/.) *</label>
                <input class="input" type="number" [(ngModel)]="nuevoServicio.precio" placeholder="0.00">
            </div>

            <div class="form-group">
                <label class="label">Descripci√≥n (Opcional)</label>
                <textarea class="input" rows="2" [(ngModel)]="nuevoServicio.descripcion"
                    placeholder="Detalles del servicio..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" (click)="cerrarModalServicio()">Cancelar</button>
                <button class="btn-primary" (click)="guardarServicioRapido()">
                    Guardar Servicio
                </button>
            </div>
        </div>
    </div>
</div>